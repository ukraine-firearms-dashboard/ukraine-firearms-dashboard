# Technical Design – Ukraine Firearm Knowledge Portal (Shiny)

> A detailed, implementation-level reference for developers and maintainers. Covers runtime architecture, data model, security, performance, and the update pipeline (GitHub Workflows + Google Drive).

The deployed dashboard can be found at: https://ukraine-firearms-dashboard-viz.share.connect.posit.cloud/
## 1) System Overview

**Stack:** 
- R/Shiny + bslib for the front end of the dashboard, 
- plotly, leaflet, DT for the visualisation, 
- Duckdb for the internal database
- Google Drive for the social media extract and the dashboard text 
- Cloudflare for hosting the screenshot and fast retrieval
- Github and Posit Cloud for the dashboard deployment
- Github workflows for triggering data, screenshot and text update

**App Modules:**

* **00_setup.R** – bootstraps libraries, Google Drive auth, DuckDB connection, *materialized view* (`v_base`) for faster load, color palette & filter choices, global date range cache.
* **01_login.R** – email‑based login & lightweight registration against `users.csv` on Google Drive; gates UI tabs; shows About/popup.
* **02_summary.R** – main dashboard module (map, metrics, over‑time bars, category chart, data table). Language toggle (ENG/UKR) with debounced, fully reactive filtering.
* **05_about.R** – renders About/resources text (from CSV) as HTML.
* **06_update.R** – admin‑only Update page; dispatches **GitHub Actions** via `workflow_dispatch` to refresh text/data/screenshot from Google Drive and regenerate screenshots.

**High‑level flow:**

1. On start, app loads `.env` (optional) and authenticates Google Drive (service token) to read/write `users.csv`. DuckDB opened with temp dir + multiple threads.
2. Data prep pushed into DuckDB views (split multi‑value fields, month bucketing). Only filtered result sets are materialized into R with `collect()`.
3. UI renders **immediately with full data**; all filters are **reactive (no submit)** with a small debounce to avoid thrashing.
4. Admins can trigger the **update pipeline** (GitHub Action) to pull new Google Drive content, rebuild derived assets, and publish.

---

## 2) Data Model & Storage

### 2.1 DuckDB database

* DB path: `data/database/ukr_firearms_dashboard.duckdb`
* Performance hints: `PRAGMA threads=4`, dedicated temp directory (`data/database/tmp`).

**Tables (minimum):**

* `ukr_socialMedia` – raw/normalized source records (includes `post_*_eng/ukr` fields).
* `ukr_socialMedia_summary` – coordinates and lookup (e.g., `post_oblast_latitude/longitude`, ENG/UKR labels).

**Views created on startup (00_setup.R):**

* `v_base`: (1 row **per item × per oblast** for each post)

  * `post_id`, `post_date`, `post_date_month = DATE_TRUNC('month')`
  * `post_item` – **split** from `post_item_eng` by `; `
  * `post_oblast` – **split** from `post_oblast_eng` by `; `
  * English text columns for author/title/content; plus `post_link`

Split/apply/aggregate is faster in DuckDB than in R; R only receives the filtered slice via `dplyr::tbl(con, sql(...)) |> collect()`.

### 2.2 Text content

* CSVs under `data/text/` (e.g., `about.csv`, `popup_start.csv`) are read at startup and also (re)generated by the **Text Update** workflow.

### 2.3 Screenshots/images

* Dashboard references static screenshots by deterministic URLs stored with Cloudflare Workers using the pattern `{YYYY-MM}/{post_id}.png`.

---

## 3) Authentication & Authorization

### 3.1 Google Drive auth

* Optional service token path via env var `GOOGLE_TOKEN` (JSON). If present, `googledrive::drive_auth(path=GOOGLE_TOKEN, scopes='drive')`.
* A local temp folder `googledrive-temp/` is used to download and stage `users.csv`.

### 3.2 Login flow

* **Login UI:** email form (`login_user_email`).
* **Validation:** app downloads `users.csv` from Drive (`drive_download()`) and tests membership through email.
* **Success:** shows **Overview** and **About** tabs; hides **Authentification** tab.
* **Admin access:** if the email matches the admin account (e.g., `ukraine.firearms.dashboard@gmail.com`), reveal the **Update** tab.

### 3.3 Registration flow

* **Sign in** collects `email`, `name`, `organisation`, `industry`.
* Append a new row to `users.csv` (with `date_signed_in`) and upload back to Drive (`drive_update()`) that is accessible to non-dev staff.

## 4) UI/UX & Modules

### 4.1 Layout & style

* `bslib` theme + cards; responsive grid with `gridlayout`; dark plot backgrounds.
* Language toggle buttons (ENG/UKR) drive a `reactiveVal("eng"|"ukr")` used for labels.

### 4.2 Filters & reactive data

* Single source of truth: `filtered_base()` (a **debounced** reactive derived from inputs: items/oblasts/date range).
* Default state renders **all data** (date range covers `[date_min, date_max]`).

### 4.3 Metrics

* **Last date:** `max(post_date)` in current filtered set.
* **Posts:** distinct `post_link` count.
* **Mentions:** total row count (or distinct pairs) depending on original definition.
* Metrics labels reflect current language.

### 4.4 Map (leaflet)

* **Mode:** per‑oblast **top‑2 items** using a concentric marker style: inner circle = top item; outer halo = second item. Radius encodes share.
* Colors keyed by **ENG item** using a fixed palette; labels rendered in ENG/UKR via a small dictionary join.
* Legend shows all items present in the current view; layer control toggles first/second layers.

### 4.5 Charts (plotly)

* **Over time:** stacked bars per month × item. Ordered per palette for stable colors.
* **By type:** horizontal bars (no in‑bar text). Hover shows count + percent.

### 4.6 Table (DT)

* Language‑aware columns with ENG fallback.
* **Item** column rendered as colored HTML badges (palette‑keyed by ENG item).
* Screenshot thumbnail (zoom on hover) and source link icon (facebook/telegram/globe).
* Download handler produces an Excel export with HTML stripped and link URLs extracted.

---

## 5) Performance Optimizations

1. **Push heavy work to DuckDB** – string splitting, grouping, time bucketing are performed in SQL views (`CREATE OR REPLACE VIEW ...`).
2. **Lazy queries** – all base tables accessed via `dplyr::tbl(con, ...)`; only the **filtered** subset is pulled with `collect()`.
3. **Debounced filtering** – `shiny::debounce(filtered_base_raw, 300)` prevents requery storms while typing/selecting.
4. **Palette & choices cached** – compute once at startup; re‑use for every render.
5. **Vectorized HTML** – badges/links built via vectorized operations to avoid per‑row loops in R.
6. **DT server mode** – enables `deferRender` + `scroller` for large tables.


## 6) Update Pipeline (GitHub Workflows + Google Drive)

The **Update** page is admin‑only and presents two buttons:

* **Text update**: dispatches workflow `update_dashboard_text.yml` in the `ukraine-firearms-dashboard` repo. This job pulls Google Drive text (e.g., `/data/text/*.csv`), regenerates packaged resources, and commits them so the app can read them on next start.

* **Data update**: dispatches **two** workflows

  1. `update_censs_content.yml` in `ukraine-firearms-dashboard` – ingests the new Excel spreadsheet and metadata found in Drive under `/data/Official withdrawal_Month_YY/Official withdrawal_Month_YY.xlsx` and updates the DuckDB or artifact used by the app.
  2. `update_censs_screenshot.yml` in `ukraine-firearms-images` – processes `/data/Official withdrawal_Month_YY/main cases/` screenshots, optimizes/renders them to the static CDN path used by the app.

### 6.1 Trigger mechanism

* Uses GitHub REST API `workflow_dispatch` via `httr::POST()`.
* Headers include `Authorization: Bearer $GITHUB_TOKEN` and `Accept: application/vnd.github.v3+json`.
* Body sets `ref = "main"` (branch to run).
* For each button click, Shiny calls:

```r
run_workflow(repo, workflow)
# where: owner = "ukraine-firearms-dashboard"
#        workflow = one of the YAML names above
```

### 6.2 Long‑running progress UX

* After dispatch, Shiny shows a progress bar (4 minutes for text, ~10 minutes for data) then prompts the user to **refresh the page** to pick up new files.

### 6.3 Google Drive conventions

* **Text**: authoritative CSVs live in Drive; update workflow syncs them into the repo or a storage bucket.
* **Data**: Drive path must contain the monthly Excel and a `main cases/` directory with screenshots; the workflows read these and publish processed outputs.

### 6.4 Secrets & configuration

* GitHub repo secrets should include `GITHUB_TOKEN` (classic token or GHA token with `workflow` scope if calling the API across repos) and, if the workflows themselves access Drive, a `GOOGLE_SERVICE_ACCOUNT` JSON or equivalent secret.
* The Shiny app sets `GITHUB_TOKEN` in its environment (e.g., `.Renviron`) for the **dispatch** step.


## Testing Checklist

* Login with registered and unregistered emails.
* Register a fresh email; confirm `users.csv` appended in Drive.
* Switch language and verify: metrics suffixes, axis labels, item badges, popups.
* Filters: items only; oblast only; date only; combined; edge cases (empty → full range). 
* Map: verify concentric circles and legend correctness; toggle layers.
* Charts: stable color mapping matching palette; hover shows expected values.
* Table: HTML badges, screenshots render, icons resolve, download file columns.
* Update page: dispatch text/data workflows; verify GitHub runs; app content updates after page refresh.

---

## Maintenance & Extensibility

* To add a new category label/language: extend the `ukr_socialMedia_summary` mapping so the palette mapping remains 1:1 with ENG keys.
* To support additional languages: generalize `language_react()` into a multi‑value setting and provide new columns in data.
* To change update cadence: add scheduled triggers to the workflows, keeping the **manual dispatch** for ad‑hoc updates.
* To add auth providers: replace the email list with OAuth/OpenID and use Drive for supplemental roles/groups.



## Contact & Ownership

* **Primary owner:** `ukraine-firearms-dashboard` org on GitHub.
* **Admin email:** `ukraine.firearms.dashboard@gmail.com` (grants Update tab access).
* **Secrets:** stored in server env + GitHub repo secrets.

xx acounts are required for the dashboard:
- Google:  `ukraine.firearms.dashboard@gmail.com`
- Github: based on Google identity
- Cloudflare: based on Github identity
- Posit Cloud: based on Github identity